<!doctype html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>PaçoquitaCakes — Gestão de Caixa & Agendamentos</title>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <style>
        :root {
            --bg: #fff8f1;
            --brown-pastel: #cda88b;
            --brown-dark: #8b5e3c;
            --yellow-pastel: #f6e7b4;
            --accent: #e1c89a;
            --muted: #7a6a63;
            --glass: rgba(255, 255, 255, 0.6);
            --card-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
            font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            background: linear-gradient(180deg, var(--bg) 0%, #fffdfa 100%);
            color: var(--brown-dark);
            min-height: 100vh;
            display: flex;
            gap: 24px;
        }

        /* Sidebar */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.65), rgba(255, 255, 255, 0.5));
            padding: 22px;
            border-right: 1px solid rgba(139, 94, 60, 0.06);
            backdrop-filter: blur(6px);
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .brand {
            display: flex;
            gap: 12px;
            align-items: center;
            cursor: pointer;
        }

        .logo {
            width: 58px;
            height: 58px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: linear-gradient(180deg, var(--yellow-pastel), var(--accent));
            box-shadow: var(--card-shadow);
        }

        .brand h1 {
            font-size: 16px;
            margin: 0;
            line-height: 1;
            color: var(--brown-dark)
        }

        .brand p {
            margin: 0;
            font-size: 12px;
            color: var(--muted)
        }

        nav {
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .nav-item {
            padding: 10px 12px;
            border-radius: 8px;
            display: flex;
            gap: 10px;
            align-items: center;
            color: var(--brown-dark);
            cursor: pointer;
            font-weight: 600;
        }

        .nav-item:hover {
            background: rgba(139, 94, 60, 0.06)
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(201, 168, 139, 0.18), rgba(246, 231, 180, 0.14));
            box-shadow: inset 0 0 0 1px rgba(139, 94, 60, 0.03)
        }

        /* Main area */
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header.app-header {
            height: 72px;
            padding: 14px 22px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(139, 94, 60, 0.04);
            background: linear-gradient(90deg, rgba(255, 255, 255, 0.7), rgba(255, 255, 255, 0.5));
            backdrop-filter: blur(6px);
        }

        header .left {
            display: flex;
            gap: 16px;
            align-items: center
        }

        header h2 {
            margin: 0;
            font-size: 18px;
            color: var(--brown-dark)
        }

        header .right {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .btn {
            background: var(--brown-pastel);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            border: 0;
            cursor: pointer;
            font-weight: 700;
            box-shadow: 0 6px 16px rgba(139, 94, 60, 0.08);
        }

        .btn.ghost {
            background: transparent;
            color: var(--brown-dark);
            border: 1px solid rgba(139, 94, 60, 0.06)
        }

        .container {
            padding: 22px;
            display: grid;
            gap: 18px
        }

        /* cards grid */
        .grid {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 16px;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 14px;
            box-shadow: var(--card-shadow);
        }

        .col-4 {
            grid-column: span 4;
        }

        .col-8 {
            grid-column: span 8;
        }

        .col-12 {
            grid-column: span 12;
        }

        .col-6 {
            grid-column: span 6;
        }

        .flex {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .muted {
            color: var(--muted);
            font-size: 13px
        }

        /* forms */
        label {
            display: block;
            font-weight: 700;
            font-size: 13px;
            margin-bottom: 6px
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid rgba(139, 94, 60, 0.08);
            outline: none;
            background: linear-gradient(180deg, #fff, #fff);
        }

        textarea {
            min-height: 80px
        }

        .inline {
            display: flex;
            gap: 8px;
            align-items: center
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        th,
        td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid rgba(139, 94, 60, 0.04);
            font-size: 14px
        }

        .small {
            font-size: 13px;
            color: var(--muted)
        }

        /* thumbnail gallery */
        .thumb {
            width: 72px;
            height: 58px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(0, 0, 0, 0.04);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .thumb img {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        /* modal image */
        .modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
        }

        .modal img {
            max-width: 90%;
            max-height: 80%;
            border-radius: 12px;
            box-shadow: 0 8px 40px rgba(0, 0, 0, 0.5)
        }

        footer.app-footer {
            padding: 12px 22px;
            border-top: 1px solid rgba(139, 94, 60, 0.04);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: transparent;
        }

        /* responsive */
        @media (max-width:1000px) {
            .sidebar {
                display: none
            }

            .grid {
                grid-template-columns: repeat(6, 1fr)
            }

            .col-4 {
                grid-column: span 6
            }

            .col-8 {
                grid-column: span 6
            }

            .col-6 {
                grid-column: span 6
            }
        }

        /* small helpers */
        .right-align {
            text-align: right
        }

        .danger {
            color: #b94a3b
        }

        .success {
            color: #2e8b57
        }

        .chip {
            display: inline-block;
            padding: 6px 10px;
            border-radius: 20px;
            background: var(--yellow-pastel);
            font-weight: 700;
            color: var(--brown-dark)
        }

        .muted-note {
            font-size: 13px;
            color: var(--muted);
            margin-top: 8px
        }

        .actions {
            display: flex;
            gap: 8px
        }

        .icon-btn {
            background: transparent;
            border: 1px solid rgba(139, 94, 60, 0.06);
            padding: 6px;
            border-radius: 8px;
            cursor: pointer
        }

        .list-empty {
            padding: 16px;
            background: linear-gradient(90deg, #fff, #fff);
            border-radius: 8px;
            text-align: center;
            color: var(--muted)
        }

        /* little floating helper */
        .mini {
            font-size: 12px;
            padding: 6px 8px;
            border-radius: 8px;
            background: linear-gradient(90deg, var(--yellow-pastel), var(--accent));
        }
    </style>
</head>

<body>
    <aside class="sidebar">
        <div class="brand" data-nav="dashboard">
            <div class="logo" aria-hidden>
                <!-- SVG logo: cake 3 tiers -->
                 <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                <g fill="none" stroke="#6b5a4b" stroke-width="1.5">
                    <ellipse cx="32" cy="52" rx="20" ry="4" fill="#fff4cc" stroke="none" />
                    <g fill="#fff4cc">
                        <rect x="12" y="40" width="40" height="8" rx="4" />
                        <rect x="16" y="28" width="32" height="8" rx="4" />
                        <rect x="22" y="14" width="20" height="8" rx="4" />
                    </g>
                    <g stroke="#caa63f">
                        <path d="M32 12c0-2 4-4 4-6s-4 0-4 0-4-2-4 0 4 4 4 6z" fill="#caa63f" />
                    </g>
                </g>
            </svg>
            </div>
            <div>
                <h1>PaçoquitaCakes</h1>
                <p>Gestão & Agendamentos</p>
            </div>
        </div>

        <nav>
            <div class="nav-item active" data-nav="dashboard">Dashboard</div>
            <div class="nav-item" data-nav="receitas">Receitas (Entradas)</div>
            <div class="nav-item" data-nav="despesas">Despesas (Saídas)</div>
            <div class="nav-item" data-nav="agendamentos">Agendamentos</div>
            <div class="nav-item" data-nav="servicos">Serviços</div>
            <div class="nav-item" data-nav="relatorios">Relatórios</div>
        </nav>

        <div style="margin-top:auto">
            <div class="muted">Tema</div>
            <div style="display:flex;gap:8px;margin-top:8px">
                <button class="btn" id="btnReset">Redefinir dados</button>
                <button class="btn ghost" id="btnExport">Exportar JSON</button>
            </div>
            <p class="muted-note">Salvo localmente no seu navegador. Faça backup com exportar.</p>
        </div>
    </aside>

    <main class="main">
        <header class="app-header">
            <div class="left">
                <h2 id="pageTitle">Dashboard</h2>
                <div class="mini" id="monthLabel"></div>
            </div>
            <div class="right">
                <div class="muted">Usuário: Paçoquita</div>
                <button class="btn" id="btnAddQuick">Novo Agendamento</button>
            </div>
        </header>

        <div class="container">
            <!-- Dashboard view -->
            <section id="dashboard" class="view">
                <div class="grid">
                    <div class="card col-4">
                        <h3>Saldo do mês</h3>
                        <div style="font-size:28px;font-weight:800;margin-top:8px" id="saldoMes">R$ 0,00</div>
                        <div class="muted-note">Entradas, saídas e saldo consolidado do mês selecionado.</div>
                        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
                            <label>Selecione mês:</label>
                            <input type="month" id="filterMonth" />
                        </div>
                    </div>

                    <div class="card col-8">
                        <h3>Fluxo — Entradas vs Saídas</h3>
                        <canvas id="chartFluxo" height="120"></canvas>
                    </div>

                    <div class="card col-4">
                        <h3>Últimas Receitas</h3>
                        <div id="recentReceitas"></div>
                    </div>

                    <div class="card col-4">
                        <h3>Últimas Despesas</h3>
                        <div id="recentDespesas"></div>
                    </div>

                    <div class="card col-4">
                        <h3>Próximos Agendamentos</h3>
                        <div id="upcoming"></div>
                    </div>

                    <div class="card col-12">
                        <h3>Relatório Rápido</h3>
                        <div id="reportQuick"></div>
                    </div>
                </div>
            </section>

            <!-- Receitas -->
            <section id="receitas" class="view" style="display:none">
                <div class="grid">
                    <div class="card col-12">
                        <h3>Registrar Receitas</h3>
                        <form id="formReceita">
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
                                <div>
                                    <label>Valor (R$)</label>
                                    <input type="number" step="0.01" id="r_valor" required />
                                </div>
                                <div>
                                    <label>Origem</label>
                                    <input type="text" id="r_origem" placeholder="Ex: Pedido #123 - Cliente" required />
                                </div>
                                <div>
                                    <label>Data</label>
                                    <input type="date" id="r_data" required />
                                </div>
                            </div>
                            <div style="margin-top:10px">
                                <label>Descrição / Observação</label>
                                <textarea id="r_desc"></textarea>
                            </div>
                            <div style="margin-top:10px;display:flex;gap:12px;align-items:center">
                                <label>Anexar comprovante</label>
                                <input type="file" id="r_file" accept="image/*" />
                                <div id="r_preview" style="display:inline-block"></div>
                                <button class="btn" type="submit">Salvar Receita</button>
                            </div>
                        </form>
                    </div>

                    <div class="card col-12">
                        <h3>Lista de Receitas</h3>
                        <table id="tblReceitas">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Origem</th>
                                    <th>Valor</th>
                                    <th>Comprovante</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Despesas -->
            <section id="despesas" class="view" style="display:none">
                <div class="grid">
                    <div class="card col-12">
                        <h3>Registrar Despesas</h3>
                        <form id="formDespesa">
                            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px">
                                <div>
                                    <label>Valor (R$)</label>
                                    <input type="number" step="0.01" id="d_valor" required />
                                </div>
                                <div>
                                    <label>Destino / Motivo</label>
                                    <input type="text" id="d_origem" placeholder="Ex: Compra de ingredientes"
                                        required />
                                </div>
                                <div>
                                    <label>Data</label>
                                    <input type="date" id="d_data" required />
                                </div>
                            </div>
                            <div style="margin-top:10px">
                                <label>Descrição / Observação</label>
                                <textarea id="d_desc"></textarea>
                            </div>
                            <div style="margin-top:10px;display:flex;gap:12px;align-items:center">
                                <label>Anexar comprovante</label>
                                <input type="file" id="d_file" accept="image/*" />
                                <div id="d_preview" style="display:inline-block"></div>
                                <button class="btn" type="submit">Salvar Despesa</button>
                            </div>
                        </form>
                    </div>

                    <div class="card col-12">
                        <h3>Lista de Despesas</h3>
                        <table id="tblDespesas">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Motivo</th>
                                    <th>Valor</th>
                                    <th>Comprovante</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Agendamentos -->
            <section id="agendamentos" class="view" style="display:none">
                <div class="grid">
                    <div class="card col-6">
                        <h3>Novo Agendamento</h3>
                        <form id="formAgendamento">
                            <div>
                                <label>Nome do Cliente</label>
                                <input type="text" id="a_cliente" required />
                            </div>
                            <div style="display:flex;gap:8px;margin-top:8px">
                                <div style="flex:1">
                                    <label>Data do Pedido</label>
                                    <input type="date" id="a_dataPedido" required />
                                </div>
                                <div style="flex:1">
                                    <label>Data de Entrega</label>
                                    <input type="date" id="a_dataEntrega" required />
                                </div>
                            </div>
                            <div style="margin-top:8px">
                                <label>Serviços (selecione um ou mais)</label>
                                <div id="servicesList"
                                    style="display:flex;flex-direction:column;gap:6px;max-height:180px;overflow:auto;padding:6px">
                                </div>
                            </div>
                            <div style="margin-top:8px" class="inline">
                                <label>Observação</label>
                                <input type="text" id="a_obs" placeholder="Ex: Cobertura extra, chantilly, etc." />
                            </div>
                            <div style="margin-top:10px">
                                <div style="display:flex;gap:8px;align-items:center">
                                    <label>Total calculado</label>
                                    <div id="a_total" style="font-weight:800">R$ 0,00</div>
                                </div>
                            </div>
                            <div style="margin-top:10px;display:flex;gap:8px">
                                <button class="btn" type="submit">Salvar Agendamento</button>
                                <button class="btn ghost" type="button" id="btnClearAg">Limpar</button>
                            </div>
                        </form>
                    </div>

                    <div class="card col-6">
                        <h3>Lista de Agendamentos</h3>
                        <table id="tblAgendamentos">
                            <thead>
                                <tr>
                                    <th>Pedido</th>
                                    <th>Cliente</th>
                                    <th>Entrega</th>
                                    <th>Serviços</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Services -->
            <section id="servicos" class="view" style="display:none">
                <div class="grid">
                    <div class="card col-4">
                        <h3>Cadastrar Serviço</h3>
                        <form id="formServico">
                            <div>
                                <label>Nome do Serviço</label>
                                <input type="text" id="s_nome" required placeholder="Ex: Bolo 20cm" />
                            </div>
                            <div style="display:flex;gap:8px;margin-top:8px">
                                <div style="flex:1">
                                    <label>Tamanho / Quantidade</label>
                                    <input type="text" id="s_tamanho" placeholder="Ex: 20cm / 12 fatias" required />
                                </div>
                                <div style="flex:1">
                                    <label>Valor (R$)</label>
                                    <input type="number" step="0.01" id="s_valor" required />
                                </div>
                            </div>
                            <div style="display:flex;gap:8px;margin-top:8px">
                                <div style="flex:1">
                                    <label>Qtd Doces</label>
                                    <input type="number" id="s_doces" value="0" min="0" />
                                </div>
                                <div style="flex:1">
                                    <label>Qtd Salgados</label>
                                    <input type="number" id="s_salgados" value="0" min="0" />
                                </div>
                            </div>
                            <div style="margin-top:10px;display:flex;gap:8px">
                                <button class="btn" type="submit">Salvar Serviço</button>
                                <button class="btn ghost" id="btnClearService" type="button">Limpar</button>
                            </div>
                        </form>
                    </div>

                    <div class="card col-8">
                        <h3>Lista de Serviços</h3>
                        <table id="tblServicos">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Tamanho</th>
                                    <th>Doces</th>
                                    <th>Salgados</th>
                                    <th>Valor</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Reports -->
            <section id="relatorios" class="view" style="display:none">
                <div class="grid">
                    <div class="card col-6">
                        <h3>Gerar Relatório Mensal</h3>
                        <div style="display:flex;gap:8px;align-items:center">
                            <input type="month" id="rel_month" />
                            <button class="btn" id="btnGenReport">Gerar</button>
                        </div>
                        <div id="rel_output" style="margin-top:12px"></div>
                    </div>

                    <div class="card col-6">
                        <h3>Exportar / Importar</h3>
                        <p class="muted-note">Backup dos dados (JSON)</p>
                        <div style="display:flex;gap:8px;margin-top:8px">
                            <button class="btn" id="btnExport2">Exportar Dados</button>
                            <input type="file" id="importFile" accept="application/json" />
                        </div>
                        <p class="muted-note">Importe um arquivo JSON salvo anteriormente para restaurar.</p>
                    </div>
                </div>
            </section>
        </div>

        <footer class="app-footer">
            <div>&copy; <strong>PaçoquitaCakes</strong> — Sistema de Gestão</div>
            <div>
                <button class="btn ghost" id="btnHelp">Ajuda</button>
            </div>
        </footer>
    </main>

    <!-- Image modal -->
    <div class="modal" id="imgModal"><img src="" alt="Comprovante" /></div>

    <script>
        /**********************************************
         * PaçoquitaCakes — App frontend (localStorage)
         * Tudo em JS puro (sem frameworks)
         **********************************************/

        // Utility
        const $ = (sel, ctx = document) => ctx.querySelector(sel);
        const $$ = (sel, ctx = document) => Array.from(ctx.querySelectorAll(sel));
        const formatMoney = v => {
            const n = Number(v) || 0;
            return n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        };
        const uid = () => Date.now().toString(36) + Math.random().toString(36).slice(2, 7);

        // Storage keys & init
        const KEY = 'pacoq_app_v1';
        const defaultState = {
            receitas: [], // {id, valor, origem, data, desc, img}
            despesas: [], // {id, valor, origem, data, desc, img}
            servicos: [], // {id, nome, tamanho, doces, salgados, valor}
            agendamentos: [] // {id, cliente, dataPedido, dataEntrega, servicos:[{id,qty}], obs, total, status('pendente'|'entregue'), comprovanteId}
        };

        function loadState() {
            const raw = localStorage.getItem(KEY);
            if (!raw) {
                localStorage.setItem(KEY, JSON.stringify(defaultState));
                return JSON.parse(JSON.stringify(defaultState));
            }
            try { return JSON.parse(raw) } catch (e) { console.error(e); localStorage.setItem(KEY, JSON.stringify(defaultState)); return JSON.parse(JSON.stringify(defaultState)); }
        }
        function saveState(s) { localStorage.setItem(KEY, JSON.stringify(s)); state = s; renderAll(); }

        let state = loadState();

        /* ---------- NAV ---------- */
        const navItems = $$('.nav-item');
        navItems.forEach(it => it.addEventListener('click', e => {
            navItems.forEach(n => n.classList.remove('active'));
            it.classList.add('active');
            const view = it.dataset.nav;
            showView(view);
        }));
        function showView(name) {
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            const v = document.getElementById(name);
            if (v) v.style.display = 'block';
            $('#pageTitle').textContent = ({ dashboard: 'Dashboard', receitas: 'Receitas', despesas: 'Despesas', agendamentos: 'Agendamentos', servicos: 'Serviços', relatorios: 'Relatórios' })[name] || name;
        }

        // initial
        showView('dashboard');

        /* ---------- Helpers: file -> base64 preview ---------- */
        function fileToBase64(file) {
            return new Promise((res, rej) => {
                const fr = new FileReader();
                fr.onload = () => res(fr.result);
                fr.onerror = e => rej(e);
                fr.readAsDataURL(file);
            });
        }

        /* ---------- Receitas ---------- */
        const formReceita = $('#formReceita');
        const r_preview = $('#r_preview');
        let r_currentFileBase64 = null;

        $('#r_file').addEventListener('change', async (e) => {
            const f = e.target.files[0];
            if (!f) return;
            r_currentFileBase64 = await fileToBase64(f);
            r_preview.innerHTML = `<div class="thumb"><img src="${r_currentFileBase64}" alt="comprovante"/></div>`;
        });

        formReceita.addEventListener('submit', e => {
            e.preventDefault();
            const valor = parseFloat($('#r_valor').value) || 0;
            const origem = $('#r_origem').value.trim();
            const data = $('#r_data').value;
            const desc = $('#r_desc').value.trim();
            const id = uid();
            state.receitas.push({ id, valor, origem, data, desc, img: r_currentFileBase64 });
            saveState(state);
            formReceita.reset(); r_preview.innerHTML = ''; r_currentFileBase64 = null;
            alert('Receita salva ✅');
        });

        /* ---------- Despesas ---------- */
        const formDespesa = $('#formDespesa');
        const d_preview = $('#d_preview');
        let d_currentFileBase64 = null;
        $('#d_file').addEventListener('change', async (e) => {
            const f = e.target.files[0]; if (!f) return;
            d_currentFileBase64 = await fileToBase64(f);
            d_preview.innerHTML = `<div class="thumb"><img src="${d_currentFileBase64}" alt="comprovante"/></div>`;
        });
        formDespesa.addEventListener('submit', e => {
            e.preventDefault();
            const valor = parseFloat($('#d_valor').value) || 0;
            const origem = $('#d_origem').value.trim();
            const data = $('#d_data').value;
            const desc = $('#d_desc').value.trim();
            const id = uid();
            state.despesas.push({ id, valor, origem, data, desc, img: d_currentFileBase64 });
            saveState(state);
            formDespesa.reset(); d_preview.innerHTML = ''; d_currentFileBase64 = null;
            alert('Despesa salva ✅');
        });

        /* ---------- Serviços ---------- */
        const formServico = $('#formServico');
        formServico.addEventListener('submit', e => {
            e.preventDefault();
            const nome = $('#s_nome').value.trim();
            const tamanho = $('#s_tamanho').value.trim();
            const doces = parseInt($('#s_doces').value) || 0;
            const salgados = parseInt($('#s_salgados').value) || 0;
            const valor = parseFloat($('#s_valor').value) || 0;
            const id = uid();
            state.servicos.push({ id, nome, tamanho, doces, salgados, valor });
            saveState(state);
            formServico.reset();
            alert('Serviço cadastrado ✅');
        });
        $('#btnClearService').addEventListener('click', () => formServico.reset());

        /* ---------- Agendamentos ---------- */
        const servicesList = $('#servicesList');
        function renderServicesCheckboxes() {
            servicesList.innerHTML = '';
            if (state.servicos.length === 0) { servicesList.innerHTML = '<div class="list-empty">Nenhum serviço cadastrado ainda.</div>'; return; }
            state.servicos.forEach(s => {
                const div = document.createElement('div');
                div.innerHTML = `<label style="display:flex;align-items:center;gap:8px"><input type="checkbox" data-id="${s.id}"/> <strong>${s.nome}</strong> — R$ ${formatMoney(s.valor)} <span class="small" style="margin-left:8px">${s.tamanho}</span></label>`;
                servicesList.appendChild(div);
            });
        }

        function calcAgTotalFromChecked() {
            const checks = Array.from(servicesList.querySelectorAll('input[type="checkbox"]'));
            let total = 0;
            const items = [];
            checks.forEach(ch => {
                if (ch.checked) {
                    const s = state.servicos.find(x => x.id === ch.dataset.id);
                    if (s) { total += Number(s.valor); items.push({ id: s.id, nome: s.nome, valor: s.valor }); }
                }
            });
            $('#a_total').textContent = 'R$ ' + formatMoney(total);
            return { total, items };
        }
        servicesList.addEventListener('change', calcAgTotalFromChecked);

        const formAg = $('#formAgendamento');
        formAg.addEventListener('submit', e => {
            e.preventDefault();
            const cliente = $('#a_cliente').value.trim();
            const dataPedido = $('#a_dataPedido').value;
            const dataEntrega = $('#a_dataEntrega').value;
            const obs = $('#a_obs').value.trim();
            const { total, items } = calcAgTotalFromChecked();
            if (items.length === 0) { if (!confirm('Nenhum serviço selecionado. Deseja salvar mesmo assim?')) return; }
            const id = uid();
            state.agendamentos.push({ id, cliente, dataPedido, dataEntrega, servicos: items, obs, total, status: 'pendente', comprovanteId: null });
            saveState(state);
            formAg.reset();
            $('#a_total').textContent = 'R$ 0,00';
            renderServicesCheckboxes();
            alert('Agendamento salvo ✅');
        });
        $('#btnClearAg').addEventListener('click', () => { formAg.reset(); $('#a_total').textContent = 'R$ 0,00'; renderServicesCheckboxes(); });

        /* ---------- Render tables & dashboard ---------- */
        const imgModal = $('#imgModal');
        imgModal.addEventListener('click', () => imgModal.style.display = 'none');

        function renderReceitasTable() {
            const tbody = $('#tblReceitas tbody'); tbody.innerHTML = '';
            if (state.receitas.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="list-empty">Nenhuma receita registrada</td></tr>'; return; }
            state.receitas.slice().sort((a, b) => new Date(b.data) - new Date(a.data)).forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td>${r.data}</td>
          <td>${r.origem}</td>
          <td>R$ ${formatMoney(r.valor)}</td>
          <td>${r.img ? `<div class="thumb" data-img="${r.img}"><img src="${r.img}" alt="comp"/></div>` : '<span class="small muted">Sem</span>'}</td>
          <td class="actions">
            <button class="icon-btn" data-id="${r.id}" data-act="view">Ver</button>
            <button class="icon-btn" data-id="${r.id}" data-act="edit">Editar</button>
            <button class="icon-btn" data-id="${r.id}" data-act="del">Apagar</button>
          </td>
        `;
                tbody.appendChild(tr);
            });
            // add listeners
            tbody.querySelectorAll('[data-act]').forEach(btn => {
                btn.addEventListener('click', e => {
                    const id = btn.dataset.id; const act = btn.dataset.act;
                    const item = state.receitas.find(x => x.id === id);
                    if (act === 'view') { if (item && item.img) { $('#imgModal img').src = item.img; imgModal.style.display = 'flex'; } else alert('Sem imagem.') }
                    if (act === 'del') { if (confirm('Apagar esta receita?')) { state.receitas = state.receitas.filter(x => x.id !== id); saveState(state); } }
                    if (act === 'edit') { if (!item) return; const novo = prompt('Novo valor (R$)', item.valor); if (novo !== null) { item.valor = parseFloat(novo) || item.valor; saveState(state); } }
                });
            });
            // thumbs enlarge
            tbody.querySelectorAll('.thumb').forEach(t => {
                t.addEventListener('click', () => { $('#imgModal img').src = t.querySelector('img').src; imgModal.style.display = 'flex'; });
            });
        }

        function renderDespesasTable() {
            const tbody = $('#tblDespesas tbody'); tbody.innerHTML = '';
            if (state.despesas.length === 0) { tbody.innerHTML = '<tr><td colspan="5" class="list-empty">Nenhuma despesa registrada</td></tr>'; return; }
            state.despesas.slice().sort((a, b) => new Date(b.data) - new Date(a.data)).forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
          <td>${r.data}</td>
          <td>${r.origem}</td>
          <td>R$ ${formatMoney(r.valor)}</td>
          <td>${r.img ? `<div class="thumb" data-img="${r.img}"><img src="${r.img}" alt="comp"/></div>` : '<span class="small muted">Sem</span>'}</td>
          <td class="actions">
            <button class="icon-btn" data-id="${r.id}" data-act="view">Ver</button>
            <button class="icon-btn" data-id="${r.id}" data-act="edit">Editar</button>
            <button class="icon-btn" data-id="${r.id}" data-act="del">Apagar</button>
          </td>
        `;
                tbody.appendChild(tr);
            });
            tbody.querySelectorAll('[data-act]').forEach(btn => {
                btn.addEventListener('click', e => {
                    const id = btn.dataset.id; const act = btn.dataset.act;
                    const item = state.despesas.find(x => x.id === id);
                    if (act === 'view') { if (item && item.img) { $('#imgModal img').src = item.img; imgModal.style.display = 'flex'; } else alert('Sem imagem.') }
                    if (act === 'del') { if (confirm('Apagar esta despesa?')) { state.despesas = state.despesas.filter(x => x.id !== id); saveState(state); } }
                    if (act === 'edit') { if (!item) return; const novo = prompt('Novo valor (R$)', item.valor); if (novo !== null) { item.valor = parseFloat(novo) || item.valor; saveState(state); } }
                });
            });
            tbody.querySelectorAll('.thumb').forEach(t => {
                t.addEventListener('click', () => { $('#imgModal img').src = t.querySelector('img').src; imgModal.style.display = 'flex'; });
            });
        }

        /* ---------- Serviços table render ---------- */
        function renderServicosTable() {
            const tbody = $('#tblServicos tbody'); tbody.innerHTML = '';
            if (state.servicos.length === 0) { tbody.innerHTML = '<tr><td colspan="6" class="list-empty">Nenhum serviço</td></tr>'; return; }
            state.servicos.forEach(s => {
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${s.nome}</td><td>${s.tamanho}</td><td>${s.doces}</td><td>${s.salgados}</td><td>R$ ${formatMoney(s.valor)}</td>
          <td class="actions">
            <button class="icon-btn" data-id="${s.id}" data-act="edit">Editar</button>
            <button class="icon-btn" data-id="${s.id}" data-act="del">Apagar</button>
          </td>`;
                tbody.appendChild(tr);
            });
            tbody.querySelectorAll('[data-act]').forEach(btn => {
                btn.addEventListener('click', e => {
                    const id = btn.dataset.id; const act = btn.dataset.act;
                    const s = state.servicos.find(x => x.id === id);
                    if (!s) return;
                    if (act === 'del') { if (confirm('Apagar este serviço?')) { state.servicos = state.servicos.filter(x => x.id !== id); saveState(state); } }
                    if (act === 'edit') {
                        const nome = prompt('Nome', s.nome); if (nome === null) return;
                        const tamanho = prompt('Tamanho', s.tamanho); if (tamanho === null) return;
                        const valor = prompt('Valor (R$)', s.valor); if (valor === null) return;
                        s.nome = nome; s.tamanho = tamanho; s.valor = parseFloat(valor) || s.valor;
                        saveState(state);
                    }
                });
            });
            renderServicesCheckboxes();
        }

        /* ---------- Agendamentos table ---------- */
        function renderAgendamentosTable() {
            const tbody = $('#tblAgendamentos tbody'); tbody.innerHTML = '';
            if (state.agendamentos.length === 0) { tbody.innerHTML = '<tr><td colspan="7" class="list-empty">Nenhum agendamento</td></tr>'; return; }
            state.agendamentos.slice().sort((a, b) => new Date(a.dataEntrega) - new Date(b.dataEntrega)).forEach(a => {
                const servs = a.servicos.map(s => s.nome).join(', ');
                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${a.id.slice(-6)}</td>
          <td>${a.cliente}</td>
          <td>${a.dataEntrega}</td>
          <td><div class="small">${servs || '<i>—</i>'}</div></td>
          <td>R$ ${formatMoney(a.total)}</td>
          <td>${a.status === 'entregue' ? '<span class="chip">Entregue</span>' : '<span class="small muted">Pendente</span>'}</td>
          <td class="actions">
            ${a.status === 'pendente' ? `<button class="icon-btn" data-id="${a.id}" data-act="mark">Marcar entregue</button>` : `<button class="icon-btn" data-id="${a.id}" data-act="viewc">Ver comprovante</button>`}
            <button class="icon-btn" data-id="${a.id}" data-act="edit">Editar</button>
            <button class="icon-btn" data-id="${a.id}" data-act="del">Apagar</button>
          </td>`;
                tbody.appendChild(tr);
            });
            tbody.querySelectorAll('[data-act]').forEach(btn => {
                btn.addEventListener('click', async e => {
                    const id = btn.dataset.id; const act = btn.dataset.act;
                    const ag = state.agendamentos.find(x => x.id === id);
                    if (!ag) return;
                    if (act === 'del') { if (confirm('Apagar este agendamento?')) { state.agendamentos = state.agendamentos.filter(x => x.id !== id); saveState(state); } }
                    if (act === 'edit') {
                        const cliente = prompt('Nome do cliente', ag.cliente); if (cliente === null) return;
                        const dataEntrega = prompt('Data de entrega (YYYY-MM-DD)', ag.dataEntrega); if (dataEntrega === null) return;
                        ag.cliente = cliente; ag.dataEntrega = dataEntrega; saveState(state);
                    }
                    if (act === 'mark') {
                        // require attaching proof image then create receita entry linked
                        const file = await promptFile('Anexe foto do comprovante (apenas imagem). Se cancelar, operação abortada.');
                        if (!file) return;
                        const b64 = await fileToBase64(file);
                        // create receita
                        const receita = { id: uid(), valor: ag.total, origem: `Pagamento pedido ${ag.id.slice(-6)} - ${ag.cliente}`, data: new Date().toISOString().slice(0, 10), desc: `Recebido por entrega do pedido ${ag.id}`, img: b64 };
                        state.receitas.push(receita);
                        ag.status = 'entregue'; ag.comprovanteId = receita.id;
                        saveState(state);
                        alert('Pedido marcado como entregue e receita registrada ✅');
                    }
                    if (act === 'viewc') {
                        const rec = state.receitas.find(r => r.id === ag.comprovanteId);
                        if (rec && rec.img) { $('#imgModal img').src = rec.img; imgModal.style.display = 'flex'; } else alert('Comprovante não encontrado.');
                    }
                });
            });
        }

        // helper to open file selection by prompt (simulate modal)
        function promptFile(message = 'Anexe imagem') {
            return new Promise((resolve) => {
                const inp = document.createElement('input');
                inp.type = 'file'; inp.accept = 'image/*';
                inp.style.display = 'none';
                document.body.appendChild(inp);
                inp.addEventListener('change', () => {
                    const f = inp.files[0];
                    document.body.removeChild(inp);
                    resolve(f || null);
                });
                if (confirm(message)) {
                    inp.click();
                } else {
                    document.body.removeChild(inp);
                    resolve(null);
                }
            });
        }

        /* ---------- Dashboard & Charts ---------- */
        const ctxFluxo = $('#chartFluxo').getContext('2d');
        let chartFluxo = null;

        function computeMonthlyTotals(yearMonth) { // "YYYY-MM"
            const [yy, mm] = yearMonth.split('-').map(Number);
            const start = new Date(yy, mm - 1, 1);
            const end = new Date(yy, mm, 1);
            const entradas = state.receitas.filter(r => new Date(r.data) >= start && new Date(r.data) < end);
            const saidas = state.despesas.filter(r => new Date(r.data) >= start && new Date(r.data) < end);
            const totalEntradas = entradas.reduce((s, x) => s + Number(x.valor), 0);
            const totalSaidas = saidas.reduce((s, x) => s + Number(x.valor), 0);
            const saldo = totalEntradas - totalSaidas;
            return { entradas, saidas, totalEntradas, totalSaidas, saldo };
        }

        function renderDashboard() {
            const monthInput = $('#filterMonth');
            // default to this month if empty
            if (!monthInput.value) {
                const now = new Date(); monthInput.value = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            }
            const ym = monthInput.value;
            $('#monthLabel').textContent = ym;
            const data = computeMonthlyTotals(ym);
            $('#saldoMes').textContent = `R$ ${formatMoney(data.saldo)}`;

            // recent lists
            $('#recentReceitas').innerHTML = data.entradas.slice(-5).reverse().map(r => `<div class="small">${r.data} — ${r.origem} — <strong>R$ ${formatMoney(r.valor)}</strong></div>`).join('') || '<div class="list-empty">Sem receitas</div>';
            $('#recentDespesas').innerHTML = data.saidas.slice(-5).reverse().map(r => `<div class="small">${r.data} — ${r.origem} — <strong>R$ ${formatMoney(r.valor)}</strong></div>`).join('') || '<div class="list-empty">Sem despesas</div>';

            // upcoming agendamentos (next 5)
            const upcoming = state.agendamentos.filter(a => new Date(a.dataEntrega) >= new Date()).slice(0, 5);
            $('#upcoming').innerHTML = upcoming.map(a => `<div class="small">${a.dataEntrega} — ${a.cliente} — R$ ${formatMoney(a.total)} — ${a.status}</div>`).join('') || '<div class="list-empty">Nenhum futuro</div>';

            // quick report
            $('#reportQuick').innerHTML = `<div style="display:flex;gap:12px">
        <div><strong>Entradas:</strong> R$ ${formatMoney(data.totalEntradas)}</div>
        <div><strong>Saídas:</strong> R$ ${formatMoney(data.totalSaidas)}</div>
        <div><strong>Saldo:</strong> R$ ${formatMoney(data.saldo)}</div>
      </div>`;

            // chart: daily sum of month
            const daysInMonth = new Date(parseInt(ym.split('-')[0]), parseInt(ym.split('-')[1]), 0).getDate();
            const labels = Array.from({ length: daysInMonth }, (_, i) => String(i + 1));
            const entradasPorDia = new Array(daysInMonth).fill(0);
            const saidasPorDia = new Array(daysInMonth).fill(0);
            state.receitas.forEach(r => {
                if (r.data && r.data.startsWith(ym)) {
                    const d = new Date(r.data).getDate();
                    entradasPorDia[d - 1] += Number(r.valor);
                }
            });
            state.despesas.forEach(r => {
                if (r.data && r.data.startsWith(ym)) {
                    const d = new Date(r.data).getDate();
                    saidasPorDia[d - 1] += Number(r.valor);
                }
            });

            if (chartFluxo) chartFluxo.destroy();
            chartFluxo = new Chart(ctxFluxo, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        { label: 'Entradas', data: entradasPorDia, borderColor: '#2e8b57', backgroundColor: 'rgba(46,139,87,0.08)', tension: 0.3, fill: true },
                        { label: 'Saídas', data: saidasPorDia, borderColor: '#b94a3b', backgroundColor: 'rgba(185,74,59,0.06)', tension: 0.3, fill: true }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { position: 'top' } },
                    scales: {
                        y: { ticks: { callback: val => 'R$ ' + Number(val).toLocaleString('pt-BR', { minimumFractionDigits: 2 }) } }
                    }
                }
            });
        }

        /* ---------- Reports ---------- */
        $('#btnGenReport').addEventListener('click', () => {
            const m = $('#rel_month').value;
            if (!m) { alert('Selecione um mês'); return; }
            const data = computeMonthlyTotals(m);
            const html = `<div>
        <h4>Relatório — ${m}</h4>
        <p><strong>Entradas:</strong> R$ ${formatMoney(data.totalEntradas)} — ${data.entradas.length} movimentos</p>
        <p><strong>Saídas:</strong> R$ ${formatMoney(data.totalSaidas)} — ${data.saidas.length} movimentos</p>
        <p><strong>Saldo:</strong> R$ ${formatMoney(data.saldo)}</p>
        <h5>Entradas (detalhe)</h5>
        <ul>${data.entradas.map(r => `<li>${r.data} — ${r.origem} — R$ ${formatMoney(r.valor)} ${r.desc ? ('— ' + r.desc) : ''}</li>`).join('')}</ul>
        <h5>Saídas (detalhe)</h5>
        <ul>${data.saidas.map(r => `<li>${r.data} — ${r.origem} — R$ ${formatMoney(r.valor)} ${r.desc ? ('— ' + r.desc) : ''}</li>`).join('')}</ul>
      </div>`;
            $('#rel_output').innerHTML = html;
        });

        /* ---------- Export / Import ---------- */
        $('#btnExport').addEventListener('click', () => downloadJSON(state, 'pacoqu_data.json'));
        $('#btnExport2').addEventListener('click', () => downloadJSON(state, 'pacoqu_data.json'));

        function downloadJSON(obj, filename = 'data.json') {
            const a = document.createElement('a');
            const blob = new Blob([JSON.stringify(obj, null, 2)], { type: 'application/json' });
            a.href = URL.createObjectURL(blob);
            a.download = filename;
            a.click();
            URL.revokeObjectURL(a.href);
        }
        $('#importFile').addEventListener('change', (e) => {
            const f = e.target.files[0];
            if (!f) return;
            const fr = new FileReader();
            fr.onload = () => {
                try {
                    const data = JSON.parse(fr.result);
                    if (confirm('Substituir os dados atuais pelo conteúdo do arquivo?')) { state = data; saveState(state); alert('Dados importados ✅'); }
                } catch (err) { alert('Arquivo inválido') }
            };
            fr.readAsText(f);
        });

        // reset
        $('#btnReset').addEventListener('click', () => {
            if (confirm('Redefinir todos os dados (excluir tudo)?')) { localStorage.removeItem(KEY); state = loadState(); renderAll(); alert('Dados redefinidos.'); }
        });

        // quick add agendamento
        $('#btnAddQuick').addEventListener('click', () => {
            $('.nav-item').forEach(n => n.classList.remove('active'));
            document.querySelector('.nav-item[data-nav="agendamentos"]').classList.add('active');
            showView('agendamentos');
        });

        $('#btnHelp').addEventListener('click', () => {
            alert('Ajuda rápida:\n\n- Cadastre serviços em Serviços.\n- Crie agendamentos em Agendamentos selecionando os serviços.\n- Ao marcar como entregue será exigido comprovante e o valor será lançado em Receitas automaticamente.\n- Faça anexos de comprovantes em Receitas/Despesas para manter o balanço.\n- Gere relatório mensal em Relatórios.\n\nSalve backup com Exportar.');
        });

        // month filter change
        $('#filterMonth').addEventListener('change', renderDashboard);

        /* ---------- Render everything ---------- */
        function renderAll() {
            renderReceitasTable();
            renderDespesasTable();
            renderServicosTable();
            renderAgendamentosTable();
            renderDashboard();
        }
        renderAll();

        // initial UI setup for month inputs
        (function setInitialMonths() {
            const now = new Date();
            const ym = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
            if (!$('#filterMonth').value) $('#filterMonth').value = ym;
            if (!$('#rel_month').value) $('#rel_month').value = ym;
            if (!$('#filterMonth').value) $('#filterMonth').value = ym;
            $('#monthLabel').textContent = ym;
        })();

        // click to enlarge any thumb in document (delegation)
        document.addEventListener('click', e => {
            const t = e.target.closest('.thumb');
            if (t && t.dataset.img) {
                $('#imgModal img').src = t.dataset.img; imgModal.style.display = 'flex';
            }
        });

    </script>
</body>

</html>

