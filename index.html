<!doctype html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>PaçoquitaCakes — Gestão</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --brown-1: #e9d8c7;
            --brown-2: #d6c0a1;
            --yellow-1: #fff4cc;
            --muted: #6b5a4b;
            --glass: rgba(255, 255, 255, 0.6);
            --accent: #caa63f;
            --radius: 12px;
            font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
        }

        * {
            box-sizing: border-box
        }

        body {
            margin: 0;
            display: flex;
            height: 100vh;
            background: linear-gradient(180deg, var(--yellow-1), #fff 60%);
            color: var(--muted)
        }

        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, var(--brown-1), var(--brown-2));
            padding: 18px;
            border-right: 1px solid rgba(0, 0, 0, 0.06);
            display: flex;
            flex-direction: column;
            gap: 18px
        }

        .logo {
            display: flex;
            gap: 12px;
            align-items: center
        }

        .logo svg {
            width: 56px;
            height: 56px
        }

        .brand {
            font-weight: 700;
            font-size: 18px
        }

        .nav {
            display: flex;
            flex-direction: column;
            gap: 6px
        }

        .nav button {
            background: transparent;
            border-radius: 10px;
            padding: 10px 12px;
            border: 0;
            text-align: left;
            cursor: pointer;
            font-weight: 600;
            color: var(--muted)
        }

        .nav button:hover {
            background: rgba(0, 0, 0, 0.04)
        }

        .nav button.active {
            background: var(--accent);
            color: white
        }

        .main {
            flex: 1;
            display: flex;
            flex-direction: column
        }

        header {
            height: 72px;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px
        }

        .container {
            padding: 18px;
            overflow: auto
        }

        .card {
            background: var(--glass);
            backdrop-filter: blur(6px);
            padding: 14px;
            border-radius: var(--radius);
            box-shadow: 0 6px 14px rgba(0, 0, 0, 0.06)
        }

        .grid {
            display: grid;
            gap: 14px
        }

        .grid.cols-3 {
            grid-template-columns: repeat(3, 1fr)
        }

        .grid.cols-2 {
            grid-template-columns: repeat(2, 1fr)
        }

        label {
            display: block;
            font-size: 13px;
            margin-bottom: 6px
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border-radius: 10px;
            border: 1px solid rgba(0, 0, 0, 0.09);
            font-size: 14px
        }

        .muted {
            font-size: 13px;
            color: #7b6a5b
        }

        .btn {
            display: inline-block;
            padding: 10px 14px;
            border-radius: 10px;
            border: 0;
            cursor: pointer
        }

        .btn.primary {
            background: var(--accent);
            color: white
        }

        .btn.ghost {
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.06)
        }

        table {
            width: 100%;
            border-collapse: collapse
        }

        th,
        td {
            padding: 10px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.04);
            text-align: left
        }

        .actions button {
            margin-right: 8px
        }

        footer {
            height: 42px;
            background: transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            color: #6b5a4b
        }

        .modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.6);
            z-index: 999
        }

        .modal.show {
            display: flex
        }

        .modal img {
            max-width: 90%;
            max-height: 80%;
            border-radius: 10px
        }

        .flex {
            display: flex;
            gap: 10px;
            align-items: center
        }

        .space-between {
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .pill {
            padding: 6px 10px;
            border-radius: 999px;
            background: rgba(0, 0, 0, 0.03);
            font-weight: 600
        }

        @media(max-width:900px) {
            .sidebar {
                display: none
            }

            .main {
                padding: 10px
            }
        }
    </style>
</head>

<body>
    <aside class="sidebar">
        <div class="logo">
            <svg viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg">
                <g fill="none" stroke="#6b5a4b" stroke-width="1.5">
                    <ellipse cx="32" cy="52" rx="20" ry="4" fill="#fff4cc" stroke="none" />
                    <g fill="#fff4cc">
                        <rect x="12" y="40" width="40" height="8" rx="4" />
                        <rect x="16" y="28" width="32" height="8" rx="4" />
                        <rect x="22" y="14" width="20" height="8" rx="4" />
                    </g>
                    <g stroke="#caa63f">
                        <path d="M32 12c0-2 4-4 4-6s-4 0-4 0-4-2-4 0 4 4 4 6z" fill="#caa63f" />
                    </g>
                </g>
            </svg>
            <div>
                <div class="brand">PaçoquitaCakes</div>
                <div class="muted">Gestão de Pedidos & Caixa</div>
            </div>
        </div>
        <nav class="nav" role="navigation">
            <button class="active" data-view="dashboard">Dashboard</button>
            <button data-view="agendamentos">Agendamentos</button>
            <button data-view="servicos">Serviços</button>
            <button data-view="caixa">Fluxo de Caixa</button>
            <button data-view="relatorios">Relatórios</button>
        </nav>
        <div style="margin-top:auto">
            <div class="muted">Usuário: Admin</div>
            <small class="muted">PaçoquitaCakes • Salvador</small>
        </div>
    </aside>

    <main class="main">
        <header>
            <div class="space-between" style="width:100%">
                <div class="flex">
                    <h2 id="view-title">Dashboard</h2>
                    <div class="pill" id="month-info"></div>
                </div>
                <div class="flex">
                    <input id="search" placeholder="Pesquisar..." />
                    <div class="muted">Dashboard • Sistema</div>
                </div>
            </div>
        </header>

        <section class="container">
            <div id="dashboard" class="view">
                <div class="grid cols-3">
                    <div class="card">
                        <div class="space-between">
                            <div>Receita mês</div>
                            <div class="muted" id="receita-mes">R$ 0,00</div>
                        </div>
                        <canvas id="chart-income" height="120"></canvas>
                    </div>
                    <div class="card">
                        <div class="space-between">
                            <div>Despesa mês</div>
                            <div class="muted" id="despesa-mes">R$ 0,00</div>
                        </div>
                        <canvas id="chart-expense" height="120"></canvas>
                    </div>
                    <div class="card">
                        <div class="space-between">
                            <div>Saldo</div>
                            <div class="muted" id="saldo-mes">R$ 0,00</div>
                        </div>
                        <canvas id="chart-balance" height="120"></canvas>
                    </div>
                </div>
                <div style="height:18px"></div>
                <div class="grid cols-2">
                    <div class="card">
                        <h3>Próximos pedidos</h3>
                        <table id="upcoming-table">
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Entrega</th>
                                    <th>Valor</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="card">
                        <h3>Produtos Disponíveis</h3>
                        <div id="services-summary"></div>
                    </div>
                </div>
            </div>

            <div id="agendamentos" class="view" style="display:none">
                <div class="card">
                    <h3>Novo agendamento</h3>
                    <div class="grid cols-2">
                        <div>
                            <label>Nome do cliente</label>
                            <input id="ag_nome" />
                        </div>
                        <div>
                            <label>Data de Recebimento do Pedido</label>
                            <input id="ag_data_receb" type="date" />
                        </div>
                        <div>
                            <label>Data de Entrega</label>
                            <input id="ag_data_entrega" type="date" />
                        </div>
                        <div>
                            <label>Serviço</label>
                            <select id="ag_servico"></select>
                        </div>
                    </div>
                    <div style="height:10px"></div>
                    <div class="flex">
                        <button class="btn primary" id="add-ag">Adicionar agendamento</button>
                        <button class="btn ghost" id="clear-ag">Limpar</button>
                    </div>
                </div>
                <div style="height:12px"></div>
                <div class="card">
                    <h3>Agendamentos</h3>
                    <table id="ag-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Entrega</th>
                                <th>Serviço</th>
                                <th>Valor</th>
                                <th>Status</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="servicos" class="view" style="display:none">
                <div class="card">
                    <h3>Cadastro de serviços</h3>
                    <div class="grid cols-3">
                        <div>
                            <label>Nome</label>
                            <input id="s_nome" placeholder="Bolo aniversário" />
                        </div>
                        <div>
                            <label>Tamanho do bolo</label>
                            <input id="s_tamanho" placeholder="15cm / 20cm" />
                        </div>
                        <div>
                            <label>Quantidade doces / salgados</label>
                            <input id="s_qtd" placeholder="Ex: 20 doces, 30 salgados" />
                        </div>
                        <div>
                            <label>Valor (R$)</label>
                            <input id="s_valor" type="number" step="0.01" />
                        </div>
                    </div>
                    <div style="height:10px"></div>
                    <div class="flex"><button class="btn primary" id="add-serv">Adicionar</button></div>
                </div>
                <div style="height:12px"></div>
                <div class="card">
                    <h3>Serviços cadastrados</h3>
                    <table id="services-table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>Tamanho</th>
                                <th>Qtd</th>
                                <th>Valor</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>

            <div id="caixa" class="view" style="display:none">
                <div class="grid cols-2">
                    <div class="card">
                        <h3>Receitas (entradas)</h3>
                        <label>Descrição</label>
                        <input id="rec_desc" />
                        <label>Valor (R$)</label>
                        <input id="rec_val" type="number" step="0.01" />
                        <label>Anexar comprovante (imagem)</label>
                        <input id="rec_file" type="file" accept="image/*" />
                        <div style="height:8px"></div>
                        <div class="flex"><button class="btn primary" id="add-rec">Adicionar receita</button></div>
                        <div style="height:8px"></div>
                        <table id="rec-table">
                            <thead>
                                <tr>
                                    <th>Descrição</th>
                                    <th>Valor</th>
                                    <th>Comprovante</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="card">
                        <h3>Despesas (saídas)</h3>
                        <label>Descrição</label>
                        <input id="des_desc" />
                        <label>Valor (R$)</label>
                        <input id="des_val" type="number" step="0.01" />
                        <label>Anexar comprovante (imagem)</label>
                        <input id="des_file" type="file" accept="image/*" />
                        <div style="height:8px"></div>
                        <div class="flex"><button class="btn primary" id="add-des">Adicionar despesa</button></div>
                        <div style="height:8px"></div>
                        <table id="des-table">
                            <thead>
                                <tr>
                                    <th>Descrição</th>
                                    <th>Valor</th>
                                    <th>Comprovante</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="relatorios" class="view" style="display:none">
                <div class="card">
                    <h3>Relatório Mensal</h3>
                    <label>Selecione mês</label>
                    <input id="report-month" type="month" />
                    <div style="height:8px"></div>
                    <div class="flex"><button class="btn primary" id="gen-report">Gerar relatório</button></div>
                </div>
                <div style="height:12px"></div>
                <div class="card" id="report-area" style="display:none"></div>
            </div>

        </section>

        <footer class="card">© PaçoquitaCakes • Sistema de Gestão — Layout moderno, responsivo e prático</footer>
    </main>

    <div class="modal" id="img-modal">
        <img id="img-modal-img" src="" alt="comprovante" />
        <button id="close-modal"
            style="position:absolute;top:20px;right:20px;padding:8px 10px;border-radius:8px;">Fechar</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Storage helpers
            const DB = {
                get(key) { const raw = localStorage.getItem(key); return raw ? JSON.parse(raw) : []; },
                set(key, val) { localStorage.setItem(key, JSON.stringify(val)); }
            };

            // initialize keys
            if (!localStorage.getItem('services')) DB.set('services', []);
            if (!localStorage.getItem('appointments')) DB.set('appointments', []);
            if (!localStorage.getItem('incomes')) DB.set('incomes', []);
            if (!localStorage.getItem('expenses')) DB.set('expenses', []);

            // cached elements
            const navButtons = Array.from(document.querySelectorAll('.nav button'));
            const views = Array.from(document.querySelectorAll('.view'));
            const monthInfoEl = document.getElementById('month-info');
            const now = new Date();
            monthInfoEl.textContent = now.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });

            // modal
            const imgModal = document.getElementById('img-modal');
            const imgModalImg = document.getElementById('img-modal-img');
            document.getElementById('close-modal').addEventListener('click', () => {
                imgModal.classList.remove('show');
                imgModalImg.src = '';
            });

            function openImage(src) {
                imgModalImg.src = src;
                imgModal.classList.add('show');
            }

            window.openImage = openImage;

            // Navigation
            function showView(viewId) {
                views.forEach(v => { v.style.display = v.id === viewId ? '' : 'none'; });
                navButtons.forEach(b => b.classList.toggle('active', b.dataset.view === viewId));
                document.getElementById('view-title').textContent = viewId.charAt(0).toUpperCase() + viewId.slice(1);
                renderAll();
            }
            navButtons.forEach(b => b.addEventListener('click', () => showView(b.dataset.view)));

            // Services
            function renderServices() {
                const services = DB.get('services');
                const tbody = document.querySelector('#services-table tbody');
                const sel = document.getElementById('ag_servico');
                tbody.innerHTML = '';
                sel.innerHTML = '';

                services.forEach((s, idx) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
          <td>${s.nome}</td>
          <td>${s.tamanho}</td>
          <td>${s.qtd}</td>
          <td>R$ ${Number(s.valor).toFixed(2)}</td>
          <td class="actions">
            <button data-idx="${idx}" class="edit-serv">Editar</button>
            <button data-idx="${idx}" class="del-serv">Remover</button>
          </td>`;
                    tbody.appendChild(tr);

                    const opt = document.createElement('option');
                    opt.value = idx;
                    opt.textContent = `${s.nome} — R$ ${Number(s.valor).toFixed(2)}`;
                    sel.appendChild(opt);
                });

                // attach handlers
                Array.from(document.querySelectorAll('.edit-serv')).forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const i = Number(e.target.dataset.idx);
                        const s = DB.get('services')[i];
                        if (!s) return;
                        document.getElementById('s_nome').value = s.nome;
                        document.getElementById('s_tamanho').value = s.tamanho;
                        document.getElementById('s_qtd').value = s.qtd;
                        document.getElementById('s_valor').value = s.valor;
                        const arr = DB.get('services');
                        arr.splice(i, 1);
                        DB.set('services', arr);
                        renderServices();
                    });
                });

                Array.from(document.querySelectorAll('.del-serv')).forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        if (!confirm('Apagar esse serviço?')) return;
                        const i = Number(e.target.dataset.idx);
                        const arr = DB.get('services');
                        arr.splice(i, 1);
                        DB.set('services', arr);
                        renderServices();
                        renderAll();
                    });
                });
            }

            document.getElementById('add-serv').addEventListener('click', () => {
                const nome = document.getElementById('s_nome').value.trim();
                if (!nome) { alert('Nome obrigatório'); return; }
                const s = {
                    nome,
                    tamanho: document.getElementById('s_tamanho').value,
                    qtd: document.getElementById('s_qtd').value,
                    valor: parseFloat(document.getElementById('s_valor').value || 0)
                };
                const arr = DB.get('services');
                arr.push(s);
                DB.set('services', arr);
                document.getElementById('s_nome').value = '';
                document.getElementById('s_tamanho').value = '';
                document.getElementById('s_qtd').value = '';
                document.getElementById('s_valor').value = '';
                renderServices();
            });

            // Appointments
            function renderAppointments() {
                const arr = DB.get('appointments');
                const tbody = document.querySelector('#ag-table tbody');
                tbody.innerHTML = '';

                arr.forEach((a, idx) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
          <td>${a.cliente}</td>
          <td>${a.data_entrega}</td>
          <td>${a.servico_nome}</td>
          <td>R$ ${Number(a.valor).toFixed(2)}</td>
          <td>${a.status || 'Pendente'}</td>
          <td class="actions">
            <button data-i="${idx}" class="mark-entrega">Marcar entregue</button>
            <button data-i="${idx}" class="edit-ag">Editar</button>
            <button data-i="${idx}" class="del-ag">Remover</button>
          </td>`;
                    tbody.appendChild(tr);
                });

                Array.from(document.querySelectorAll('.del-ag')).forEach(b => {
                    b.addEventListener('click', (e) => {
                        if (!confirm('Apagar agendamento?')) return;
                        const i = Number(e.target.dataset.i);
                        const a = DB.get('appointments');
                        a.splice(i, 1);
                        DB.set('appointments', a);
                        renderAppointments();
                        renderAll();
                    });
                });

                Array.from(document.querySelectorAll('.edit-ag')).forEach(b => {
                    b.addEventListener('click', (e) => {
                        const i = Number(e.target.dataset.i);
                        const a = DB.get('appointments')[i];
                        if (!a) return;
                        document.getElementById('ag_nome').value = a.cliente;
                        document.getElementById('ag_data_receb').value = a.data_receb || '';
                        document.getElementById('ag_data_entrega').value = a.data_entrega || '';
                        const services = DB.get('services');
                        const optIndex = services.findIndex(s => s.nome === a.servico_nome);
                        if (optIndex >= 0) document.getElementById('ag_servico').value = optIndex;
                        const arr = DB.get('appointments');
                        arr.splice(i, 1);
                        DB.set('appointments', arr);
                        renderAppointments();
                    });
                });

                Array.from(document.querySelectorAll('.mark-entrega')).forEach(b => {
                    b.addEventListener('click', (e) => {
                        const i = Number(e.target.dataset.i);
                        if (!confirm('Deseja marcar como entregue? Será necessário anexar o comprovante de pagamento.')) return;
                        const fileInput = document.createElement('input');
                        fileInput.type = 'file';
                        fileInput.accept = 'image/*';
                        fileInput.addEventListener('change', (ev) => {
                            const f = ev.target.files[0];
                            if (!f) return;
                            const reader = new FileReader();
                            reader.onload = () => {
                                const data = reader.result;
                                const appointments = DB.get('appointments');
                                if (!appointments[i]) return;
                                appointments[i].status = 'Entregue';
                                appointments[i].comprovante = data;
                                DB.set('appointments', appointments);

                                // add to incomes
                                const income = {
                                    desc: `Pagamento - ${appointments[i].cliente}`,
                                    valor: appointments[i].valor,
                                    data: new Date().toISOString(),
                                    comprovante: data
                                };
                                const incomes = DB.get('incomes');
                                incomes.push(income);
                                DB.set('incomes', incomes);

                                renderAppointments();
                                renderAll();
                                alert('Pedido marcado como entregue e receita registrada.');
                            };
                            reader.readAsDataURL(f);
                        });
                        fileInput.click();
                    });
                });
            }

            document.getElementById('add-ag').addEventListener('click', () => {
                const cliente = document.getElementById('ag_nome').value.trim();
                if (!cliente) { alert('Nome do cliente obrigatório'); return; }
                const data_receb = document.getElementById('ag_data_receb').value;
                const data_entrega = document.getElementById('ag_data_entrega').value;
                const sidx = document.getElementById('ag_servico').value;
                const serv = DB.get('services')[sidx];
                if (!serv) { alert('Escolha um serviço cadastrado'); return; }
                const ag = {
                    cliente,
                    data_receb,
                    data_entrega,
                    servico_nome: serv.nome,
                    servico_id: sidx,
                    valor: serv.valor,
                    status: 'Pendente'
                };
                const arr = DB.get('appointments');
                arr.push(ag);
                DB.set('appointments', arr);
                document.getElementById('ag_nome').value = '';
                document.getElementById('ag_data_receb').value = '';
                document.getElementById('ag_data_entrega').value = '';
                renderAppointments();
                renderAll();
            });

            document.getElementById('clear-ag').addEventListener('click', () => {
                document.getElementById('ag_nome').value = '';
                document.getElementById('ag_data_receb').value = '';
                document.getElementById('ag_data_entrega').value = '';
            });

            // Cash (incomes/expenses)
            function renderCash() {
                const incomes = DB.get('incomes');
                const expenses = DB.get('expenses');
                const rt = document.querySelector('#rec-table tbody');
                const dt = document.querySelector('#des-table tbody');
                rt.innerHTML = '';
                dt.innerHTML = '';

                incomes.forEach((r, idx) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
          <td>${r.desc}</td>
          <td>R$ ${Number(r.valor).toFixed(2)}</td>
          <td>${r.comprovante ? '<button class="view-img" data-src="' + r.comprovante + '">Ver</button>' : ''}</td>
          <td class="actions"><button data-i="${idx}" class="del-rec">Remover</button></td>`;
                    rt.appendChild(tr);
                });

                expenses.forEach((r, idx) => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
          <td>${r.desc}</td>
          <td>R$ ${Number(r.valor).toFixed(2)}</td>
          <td>${r.comprovante ? '<button class="view-img" data-src="' + r.comprovante + '">Ver</button>' : ''}</td>
          <td class="actions"><button data-i="${idx}" class="del-des">Remover</button></td>`;
                    dt.appendChild(tr);
                });

                Array.from(document.querySelectorAll('.view-img')).forEach(b => {
                    b.addEventListener('click', (e) => {
                        openImage(e.target.dataset.src);
                    });
                });

                Array.from(document.querySelectorAll('.del-rec')).forEach(b => {
                    b.addEventListener('click', (e) => {
                        if (!confirm('Remover receita?')) return;
                        const i = Number(e.target.dataset.i);
                        const arr = DB.get('incomes');
                        arr.splice(i, 1);
                        DB.set('incomes', arr);
                        renderCash();
                        renderAll();
                    });
                });

                Array.from(document.querySelectorAll('.del-des')).forEach(b => {
                    b.addEventListener('click', (e) => {
                        if (!confirm('Remover despesa?')) return;
                        const i = Number(e.target.dataset.i);
                        const arr = DB.get('expenses');
                        arr.splice(i, 1);
                        DB.set('expenses', arr);
                        renderCash();
                        renderAll();
                    });
                });
            }

            function toBase64(file) {
                return new Promise((resolve, reject) => {
                    const r = new FileReader();
                    r.onload = () => resolve(r.result);
                    r.onerror = reject;
                    r.readAsDataURL(file);
                });
            }

            document.getElementById('add-rec').addEventListener('click', async () => {
                const desc = document.getElementById('rec_desc').value || 'Receita';
                const val = parseFloat(document.getElementById('rec_val').value || 0);
                const f = document.getElementById('rec_file').files[0];
                if (!val) { alert('Valor obrigatório'); return; }
                if (f) {
                    const data = await toBase64(f);
                    const arr = DB.get('incomes');
                    arr.push({ desc, valor: val, data: new Date().toISOString(), comprovante: data });
                    DB.set('incomes', arr);
                } else {
                    const arr = DB.get('incomes');
                    arr.push({ desc, valor: val, data: new Date().toISOString() });
                    DB.set('incomes', arr);
                }
                document.getElementById('rec_desc').value = '';
                document.getElementById('rec_val').value = '';
                document.getElementById('rec_file').value = '';
                renderCash();
                renderAll();
            });

            document.getElementById('add-des').addEventListener('click', async () => {
                const desc = document.getElementById('des_desc').value || 'Despesa';
                const val = parseFloat(document.getElementById('des_val').value || 0);
                const f = document.getElementById('des_file').files[0];
                if (!val) { alert('Valor obrigatório'); return; }
                if (f) {
                    const data = await toBase64(f);
                    const arr = DB.get('expenses');
                    arr.push({ desc, valor: val, data: new Date().toISOString(), comprovante: data });
                    DB.set('expenses', arr);
                } else {
                    const arr = DB.get('expenses');
                    arr.push({ desc, valor: val, data: new Date().toISOString() });
                    DB.set('expenses', arr);
                }
                document.getElementById('des_desc').value = '';
                document.getElementById('des_val').value = '';
                document.getElementById('des_file').value = '';
                renderCash();
                renderAll();
            });

            // Reports
            document.getElementById('gen-report').addEventListener('click', () => {
                const m = document.getElementById('report-month').value;
                if (!m) { alert('Selecione o mês'); return; }
                const [year, month] = m.split('-');
                const incomes = DB.get('incomes').filter(i => new Date(i.data).getFullYear() === Number(year) && new Date(i.data).getMonth() + 1 === Number(month));
                const expenses = DB.get('expenses').filter(i => new Date(i.data).getFullYear() === Number(year) && new Date(i.data).getMonth() + 1 === Number(month));
                let html = `<h4>Relatório - ${month}/${year}</h4>`;
                html += `<p>Total entradas: R$ ${incomes.reduce((s, it) => s + Number(it.valor), 0).toFixed(2)}</p>`;
                html += `<p>Total saídas: R$ ${expenses.reduce((s, it) => s + Number(it.valor), 0).toFixed(2)}</p>`;
                html += `<h5>Detalhes entradas</h5><ul>` + incomes.map(i => `<li>${i.desc} — R$ ${Number(i.valor).toFixed(2)}</li>`).join('') + `</ul>`;
                html += `<h5>Detalhes saídas</h5><ul>` + expenses.map(i => `<li>${i.desc} — R$ ${Number(i.valor).toFixed(2)}</li>`).join('') + `</ul>`;
                const reportArea = document.getElementById('report-area');
                reportArea.innerHTML = html;
                reportArea.style.display = 'block';
            });

            // Charts & renderAll
            let chartIncome = null, chartExpense = null, chartBalance = null;

            function formatBR(num) {
                return 'R$ ' + Number(num).toFixed(2).replace('.', ',');
            }

            function renderAll() {
                renderServices();
                renderAppointments();
                renderCash();

                const incomes = DB.get('incomes');
                const expenses = DB.get('expenses');
                const mes = now.getMonth() + 1;
                const ano = now.getFullYear();

                const receitaMes = incomes.filter(i => new Date(i.data).getMonth() + 1 === mes && new Date(i.data).getFullYear() === ano).reduce((s, i) => s + Number(i.valor), 0);
                const despesaMes = expenses.filter(i => new Date(i.data).getMonth() + 1 === mes && new Date(i.data).getFullYear() === ano).reduce((s, i) => s + Number(i.valor), 0);

                document.getElementById('receita-mes').textContent = formatBR(receitaMes);
                document.getElementById('despesa-mes').textContent = formatBR(despesaMes);
                document.getElementById('saldo-mes').textContent = formatBR(receitaMes - despesaMes);

                /// upcoming
                const today = new Date();
                today.setHours(0, 0, 0, 0); // normaliza p/ início do dia

                const appointments = DB.get('appointments');

                // Mostra pedidos futuros, do mesmo dia, ou sem data de entrega
                const upcoming = appointments
                    .filter(a => {
                        if (!a.data_entrega) return true;
                        const entrega = new Date(a.data_entrega);
                        entrega.setHours(0, 0, 0, 0);
                        return entrega >= today;
                    })
                    .sort((a, b) => new Date(a.data_entrega || today) - new Date(b.data_entrega || today))
                    .slice(0, 6);

                const tbodyUp = document.querySelector('#upcoming-table tbody');
                tbodyUp.innerHTML = '';

                upcoming.forEach(u => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
    <td>${u.cliente}</td>
    <td>${u.data_entrega || '—'}</td>
    <td>R$ ${Number(u.valor).toFixed(2)}</td>
    <td><button class="view-appointment">Ver</button></td>`;
                    tbodyUp.appendChild(tr);
                });


                const ss = DB.get('services');
                const summary = document.getElementById('services-summary');
                summary.innerHTML = ss.length ? ss.map(s => `<div>${s.nome} — R$ ${Number(s.valor).toFixed(2)}</div>`).join('') : '<div class="muted">Nenhum serviço cadastrado</div>';

                // prepare last 6 months
                const months = [];
                const incomesData = [];
                const expensesData = [];
                for (let i = 5; i >= 0; i--) {
                    const d = new Date();
                    d.setMonth(d.getMonth() - i);
                    months.push(d.toLocaleString('pt-BR', { month: 'short', year: '2-digit' }));
                    const inc = DB.get('incomes').filter(x => new Date(x.data).getMonth() === d.getMonth() && new Date(x.data).getFullYear() === d.getFullYear()).reduce((s, x) => s + Number(x.valor), 0);
                    const exp = DB.get('expenses').filter(x => new Date(x.data).getMonth() === d.getMonth() && new Date(x.data).getFullYear() === d.getFullYear()).reduce((s, x) => s + Number(x.valor), 0);
                    incomesData.push(inc);
                    expensesData.push(exp);
                }

                // update/create charts
                const ctxInc = document.getElementById('chart-income').getContext('2d');
                if (!chartIncome) {
                    chartIncome = new Chart(ctxInc, { type: 'line', data: { labels: months, datasets: [{ label: 'Receitas', data: incomesData, fill: true }] }, options: { responsive: true } });
                } else {
                    chartIncome.data.labels = months;
                    chartIncome.data.datasets[0].data = incomesData;
                    chartIncome.update();
                }

                const ctxExp = document.getElementById('chart-expense').getContext('2d');
                if (!chartExpense) {
                    chartExpense = new Chart(ctxExp, { type: 'line', data: { labels: months, datasets: [{ label: 'Despesas', data: expensesData, fill: true }] }, options: { responsive: true } });
                } else {
                    chartExpense.data.labels = months;
                    chartExpense.data.datasets[0].data = expensesData;
                    chartExpense.update();
                }

                const bal = months.map((m, i) => incomesData[i] - expensesData[i]);
                const ctxBal = document.getElementById('chart-balance').getContext('2d');
                if (!chartBalance) {
                    chartBalance = new Chart(ctxBal, { type: 'bar', data: { labels: months, datasets: [{ label: 'Saldo', data: bal }] }, options: { responsive: true } });
                } else {
                    chartBalance.data.labels = months;
                    chartBalance.data.datasets[0].data = bal;
                    chartBalance.update();
                }
            }

            // initial render
            renderAll();

            // search handler (kept minimal)
            document.getElementById('search').addEventListener('input', (e) => {
                const q = e.target.value.toLowerCase();
                // future: implement filtering/highlighting
            });

        }); // DOMContentLoaded
    </script>
</body>

</html>
